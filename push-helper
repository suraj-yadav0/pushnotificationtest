#!/bin/bash
# Push helper script for pushnotification app
# This script processes incoming push notifications and triggers system notifications

APP_ID="pushnotification.surajyadav_pushnotification"
LOG_FILE="/tmp/push-helper.log"

echo "$(date): Push notification received for $APP_ID" >> "$LOG_FILE"
echo "Args: $@" >> "$LOG_FILE"

# For demonstration purposes, create a test notification directly
# In a real app, this would process the actual push message from the server
echo "$(date): Creating test system notification via Postal service" >> "$LOG_FILE"

# Create a notification in the correct Postal format
NOTIFICATION_DATA='{
    "message": "Push notification received!",
    "notification": {
        "card": {
            "summary": "Push Notification",
            "body": "You have received a push notification!",
            "popup": true,
            "persist": true
        },
        "sound": true,
        "vibrate": true,
        "tag": "push-demo"
    }
}'

# Use gdbus to post directly to the Postal service
gdbus call --session \
    --dest com.lomiri.Postal \
    --object-path "/com/lomiri/Postal/pushnotification_2esurajyadav" \
    --method com.lomiri.Postal.Post \
    "$APP_ID" \
    "$NOTIFICATION_DATA" >> "$LOG_FILE" 2>&1

echo "$(date): Notification posted to Postal service" >> "$LOG_FILE"

exit 0
